(function(a){a.plugin=function(c,b){a.fn[c]=function(e){var d=Array.prototype.slice.call(arguments,1);return this.each(function(){var f=a.data(this,c);if(f){e&&f[e].apply(f,d)}else{if(typeof b==="function"){f=new b(e,this)}else{function g(){}g.prototype=b;f=new g();f.init(e,this)}a.data(this,c,f)}})}}})(jQuery);(function(){var a=false,b=/xyz/.test(function(){xyz})?(/\b_super\b/):(/.*/);this.Class=function(){};Class.extend=function(g){var f=this.prototype;a=true;var e=new this();a=false;for(var d in g){e[d]=typeof g[d]=="function"&&typeof f[d]=="function"&&b.test(g[d])?(function(h,i){return function(){var k=this._super;this._super=f[h];var j=i.apply(this,arguments);this._super=k;return j}})(d,g[d]):g[d]}function c(){if(!a&&this.init){this.init.apply(this,arguments)}}c.prototype=e;c.constructor=c;c.extend=arguments.callee;return c}})();(function($){$.toJSON=function(o){if(typeof(JSON)=="object"&&JSON.stringify){return JSON.stringify(o)}var type=typeof(o);if(o===null){return"null"}if(type=="undefined"){return undefined}if(type=="number"||type=="boolean"){return o+""}if(type=="string"){return $.quoteString(o)}if(type=="object"){if(typeof o.toJSON=="function"){return $.toJSON(o.toJSON())}if(o.constructor===Date){var month=o.getUTCMonth()+1;if(month<10){month="0"+month}var day=o.getUTCDate();if(day<10){day="0"+day}var year=o.getUTCFullYear();var hours=o.getUTCHours();if(hours<10){hours="0"+hours}var minutes=o.getUTCMinutes();if(minutes<10){minutes="0"+minutes}var seconds=o.getUTCSeconds();if(seconds<10){seconds="0"+seconds}var milli=o.getUTCMilliseconds();if(milli<100){milli="0"+milli}if(milli<10){milli="0"+milli}return'"'+year+"-"+month+"-"+day+"T"+hours+":"+minutes+":"+seconds+"."+milli+'Z"'}if(o.constructor===Array){var ret=[];for(var i=0;i<o.length;i++){ret.push($.toJSON(o[i])||"null")}return"["+ret.join(",")+"]"}var pairs=[];for(var k in o){var name;var type=typeof k;if(type=="number"){name='"'+k+'"'}else{if(type=="string"){name=$.quoteString(k)}else{continue}}if(typeof o[k]=="function"){continue}var val=$.toJSON(o[k]);pairs.push(name+":"+val)}return"{"+pairs.join(", ")+"}"}};$.evalJSON=function(src){if(typeof(JSON)=="object"&&JSON.parse){return JSON.parse(src)}return eval("("+src+")")};$.secureEvalJSON=function(src){if(typeof(JSON)=="object"&&JSON.parse){return JSON.parse(src)}var filtered=src;filtered=filtered.replace(/\\["\\\/bfnrtu]/g,"@");filtered=filtered.replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]");filtered=filtered.replace(/(?:^|:|,)(?:\s*\[)+/g,"");if(/^[\],:{}\s]*$/.test(filtered)){return eval("("+src+")")}else{throw new SyntaxError("Error parsing JSON, source is not valid.")}};$.quoteString=function(string){if(string.match(_escapeable)){return'"'+string.replace(_escapeable,function(a){var c=_meta[a];if(typeof c==="string"){return c}c=a.charCodeAt();return"\\u00"+Math.floor(c/16).toString(16)+(c%16).toString(16)})+'"'}return'"'+string+'"'};var _escapeable=/["\\\x00-\x1f\x7f-\x9f]/g;var _meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"}})(jQuery);(function(a){this.DelegatorClass=Class.extend({events:{},init:function(){var b=this;a.each(this.events,function(e,d){var c=e.split(" ");b.addDelegatedEvent(c.slice(0,-1).join(" "),c.slice(-1)[0],d)})},addDelegatedEvent:function(f,c,d){var b=this,e=function(g){return b[d].apply(b,arguments)};this.element=this.element||document.body;if(typeof(f)==="string"&&f.replace(/\s+/g,"")===""){f=this.element}if(typeof(f)==="string"){a(this.element).delegate(f,c,e)}else{a(f).bind(c,e)}}});a.extend({inject:function(b,d,c){a.each(b,function(e,f){d=c(d,f,e)});return d},flatten:function(b){return a.inject(b,[],function(d,c){return d.concat(a.isArray(c)?a.flatten(c):c)})}});a.fn.textNodes=function(){function b(c){if(c.nodeType!==Node.TEXT_NODE){return a(c).contents().map(function(){return b(this)}).get()}else{return c}}return this.map(function(){return a.flatten(b(this))})};a.fn.xpath=function(b){return this.map(function(){var e="";for(var d=this;d&&d.nodeType==Node.ELEMENT_NODE&&d!==b;d=d.parentNode){var c=a(d.parentNode).children(d.tagName).index(d)+1;c=c>1?"["+c+"]":"";e="/"+d.tagName.toLowerCase()+c+e}return e}).get()}})(jQuery);(function(a){this.Annotator=DelegatorClass.extend({events:{"-adder mousedown":"adderMousedown","-highlighter mouseover":"highlightMouseover","-highlighter mouseout":"startViewerHideTimer","-viewer mouseover":"viewerMouseover","-viewer mouseout":"startViewerHideTimer","-controls .edit click":"controlEditClick","-controls .del click":"controlDeleteClick"},options:{classPrefix:"annot",adder:"<div><a href='#'></a></div>",editor:"<div><textarea></textarea></div>",highlighter:"<span></span>",viewer:"<div></div>"},init:function(c,d){var b=this;this.options=a.extend(this.options,c);this.element=d;this.dom={};a(this.element).wrapInner('<div class="'+this.getComponentClassname("wrapper")+'" />');this.wrapper=a(this.element).find("."+this.getComponentClassname("wrapper")).get(0);this.addDelegatedEvent(this.element,"mouseup","checkForEndSelection");this.addDelegatedEvent(this.element,"mousedown","checkForStartSelection");a.each(this.events,function(f,e){if(f.substr(0,1)==="-"){b.events["."+b.options.classPrefix+f]=e;delete b.events[f]}});this._super();a.each(["adder","editor","highlighter","viewer"],function(e,f){b.dom[f]=a(b.options[f]).attr({"class":b.getComponentClassname(f)}).appendTo(b.wrapper).hide()})},checkForStartSelection:function(b){this.startViewerHideTimer();this.mouseIsDown=true},checkForEndSelection:function(d){this.mouseIsDown=false;if(this.ignoreMouseup){this.ignoreMouseup=false;return}this.getSelection();var c=this.selection,b=c&&c.rangeCount>0&&!c.isCollapsed;if(d&&b){this.dom.adder.css(this._mousePosition(d)).show()}else{this.dom.adder.hide()}},getSelection:function(){this.selection=window.getSelection();this.selectedRanges=[];for(var b=0;b<this.selection.rangeCount;b+=1){this.selectedRanges.push(this.selection.getRangeAt(b))}},createAnnotation:function(b){var c=this;b=b||{};b.highlights=b.highlights||[];b.ranges=a.map(b.ranges||this.selectedRanges,function(e){var d,f;if("commonAncestorContainer" in e){d=c.normRange(e);f=c.serializeRange(d)}else{if(("start" in e)&&(typeof e.start=="string")){d=c.deserializeRange(e);f=e}else{d=e;f=c.serializeRange(d)}}b.highlights=b.highlights.concat(c.highlightRange(d));return f});a(b.highlights).data("annotation",b);a(this.element).trigger("annotationCreated",[b]);return b},deleteAnnotation:function(b){a.each(b.highlights,function(){a(this).replaceWith(a(this)[0].childNodes)});a(this.element).trigger("annotationDeleted",[b])},updateAnnotation:function(b,c){a.extend(b,c);a(this.element).trigger("annotationUpdated",[b])},loadAnnotations:function(e,f){f=f||function(){};var c=this,d=[];var b=function(g){now=g.splice(0,10);a.each(now,function(){d.push(c.createAnnotation(this))});if(g.length>0){setTimeout(function(){b(g)},100)}else{f(d)}};b(e)},normRange:function(b){var d={},c={};a.each(["start","end"],function(e,h){var f,g=b[h+"Container"],i=b[h+"Offset"];if(g.nodeType===Node.ELEMENT_NODE){f=g.childNodes[i];g=f||g.childNodes[i-1];while(g.nodeType!==Node.TEXT_NODE){g=g.firstChild}i=f?0:g.nodeValue.length}d[h]=g;d[h+"Offset"]=i});c.start=(d.startOffset>0)?d.start.splitText(d.startOffset):d.start;if(d.start===d.end){if((d.endOffset-d.startOffset)<c.start.nodeValue.length){c.start.splitText(d.endOffset-d.startOffset)}c.end=c.start}else{if(d.endOffset<d.end.nodeValue.length){d.end.splitText(d.endOffset)}c.end=d.end}c.commonAncestor=b.commonAncestorContainer;while(c.commonAncestor.nodeType!==Node.ELEMENT_NODE){c.commonAncestor=c.commonAncestor.parentNode}return c},serializeRange:function(e){var d=this;var b=function(j,k){var h=a(j).parents(":not(."+d.getComponentClassname("highlighter")+")").eq(0),g=h.xpath(d.wrapper)[0],i=h.textNodes(),l=a.inject(i.slice(0,i.index(j)),0,function(n,m){return n+m.nodeValue.length});return k?[g,l+j.nodeValue.length]:[g,l]},f=b(e.start),c=b(e.end,true);return{start:f[0],end:c[0],startOffset:f[1],endOffset:c[1]}},deserializeRange:function(e){var c=function(k){return document.evaluate(k,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue};var g=a(this.wrapper).xpath()[0],b=e.start.split("/"),i=e.end.split("/"),f=[],d={};for(var j=0;j<b.length;j+=1){if(b[j]===i[j]){f.push(b[j])}else{break}}var h=g+f.join("/");d.commonAncestorContainer=c(h);if(!d.commonAncestorContainer){console.error("Error deserializing range: can't find XPath '"+h+"'. Is this the right document?")}a.each(["start","end"],function(){var k=this,l=0;a(c(g+e[this])).textNodes().each(function(){if(l+this.nodeValue.length>=e[k+"Offset"]){d[k+"Container"]=this;d[k+"Offset"]=e[k+"Offset"]-l;return false}else{l+=this.nodeValue.length;return true}})});return this.normRange(d)},highlightRange:function(d){var c=this,e=a(d.commonAncestor).textNodes(),b=[];e.slice(e.index(d.start),e.index(d.end)+1).each(function(){var f=c.dom.highlighter.clone().show();b.push(a(this).wrap(f).parent().get(0))});return b},showEditor:function(d,b){var c=this;if(b){this.dom.editor.find("textarea").val(b.text)}this.dom.editor.css(this._mousePosition(d)).show().find("textarea").focus().bind("keydown",function(f){if(f.keyCode==27){a(this).val("").unbind().parent().hide()}else{if(f.keyCode==13&&!f.shiftKey){a(this).unbind().parent().hide();if(b){c.updateAnnotation(b,{text:a(this).val()})}else{c.createAnnotation({text:a(this).val()})}a(this).val("")}}}).bind("blur",function(f){a(this).val("").unbind().parent().hide()});this.ignoreMouseup=true},showViewer:function(d,c){var b='<span class="'+this.getComponentClassname("controls")+'"><a href="#" class="edit" alt="Edit" title="Edit this annotation">Edit</a><a href="#" class="del" alt="X" title="Delete this annotation">Delete</a></span>';var f=this.dom.viewer.clone().empty();a.each(c,function(e,g){a("<p>"+g.text+b+"</p>").appendTo(f).data("annotation",g)});f.css(this._mousePosition(d)).replaceAll(this.dom.viewer).show();a(this.element).trigger("annotationViewerShown",[f.get(0),c]);this.dom.viewer=f},startViewerHideTimer:function(b){if(!this.viewerHideTimer){this.viewerHideTimer=setTimeout(function(c){c.dom.viewer.hide()},250,this)}},clearViewerHideTimer:function(){clearTimeout(this.viewerHideTimer);this.viewerHideTimer=false},highlightMouseover:function(c){this.clearViewerHideTimer();if(this.mouseIsDown){return false}var b=a(c.target).parents("."+this.getComponentClassname("highlighter")).andSelf().map(function(){return a(this).data("annotation")});this.showViewer(c,b)},adderMousedown:function(b){this.dom.adder.hide();this.showEditor(b);return false},viewerMouseover:function(b){this.clearViewerHideTimer()},controlEditClick:function(c){var b=a(c.target).parents("p"),d=this._fakePositionFromElement(this.dom.viewer);this.dom.viewer.hide();this.showEditor(d,b.data("annotation"));return false},controlDeleteClick:function(c){var b=a(c.target).parents("p");this.deleteAnnotation(b.data("annotation"));b.remove();if(!this.dom.viewer.is(":parent")){this.dom.viewer.hide()}return false},addPlugin:function(b,c){return new b(c,this.element)},getComponentClassname:function(b){return this.options.classPrefix+"-"+b},_mousePosition:function(b){return{top:b.pageY-a(this.wrapper).offset().top,left:b.pageX-a(this.wrapper).offset().left}},_fakePositionFromElement:function(b){return{pageY:a(b).offset().top,pageX:a(b).offset().left}}});Annotator.Plugins={};a.plugin("annotator",Annotator)})(jQuery);(function(b){function a(c){c=b.extend({dataType:"json",success:function(){}},c);return b.ajax(c)}Annotator.Plugins.Store=DelegatorClass.extend({events:{annotationCreated:"annotationCreated",annotationDeleted:"annotationDeleted",annotationUpdated:"annotationUpdated"},options:{prefix:"/store",annotationData:{},loadFromSearch:false,urls:{create:"/annotations",read:"/annotations/:id",update:"/annotations/:id",destroy:"/annotations/:id",search:"/search"}},init:function(d,e){var c=this;this.options=b.extend(this.options,d);this.options.annotator=b(e).data("annotator");this.element=e;this.annotations=[];var f=c._super;var g=function(){f.apply(c)};if(this.options.loadFromSearch){this.loadAnnotationsFromSearch(this.options.loadFromSearch,g)}else{this.loadAnnotations(g)}},annotationCreated:function(f,c){var d=this;if(this.annotations.indexOf(c)===-1){this.registerAnnotation(c);a({url:this._urlFor("create"),data:this._dataFor(c),type:"POST",success:function(e){if(!("id" in e)){console.warn("Warning: No ID returned from server for annotation ",c)}d.updateAnnotation(c,e)}})}else{this.updateAnnotation(c,{})}},annotationDeleted:function(f,c){var d=this;if(b.inArray(c,this.annotations)!==-1){a({url:this._urlFor("destroy",c.id),type:"DELETE",success:function(){d.unregisterAnnotation(c)}})}},annotationUpdated:function(f,c){var d=this;if(b.inArray(c,this.annotations)!==-1){a({url:this._urlFor("update",c.id),type:"PUT",data:this._dataFor(c),success:function(){d.updateAnnotation(c)}})}},registerAnnotation:function(c){this.annotations.push(c)},unregisterAnnotation:function(c){this.annotations.splice(this.annotations.indexOf(c),1)},updateAnnotation:function(c,d){if(b.inArray(c,this.annotations)===-1){console.error("Trying to update unregistered annotation!")}else{b.extend(c,d)}b(c.highlights).data("annotation",c)},loadAnnotations:function(d){var c=this;a({url:this._urlFor("read"),type:"GET",success:function(e){c.annotations=e;c.options.annotator.loadAnnotations(c.annotations,d)}})},loadAnnotationsFromSearch:function(d,e){var c=this;a({url:this._urlFor("search"),type:"GET",data:d,success:function(f){c.annotations=f.results;c.options.annotator.loadAnnotations(c.annotations,e)}})},setAnnotationData:function(c){this.options.annotationData=c},_urlFor:function(d,e){var c=this.options.prefix||"/";c+=this.options.urls[d].replace(/\/:id/,e?"/"+e:"");return c},_dataFor:function(c){var e=c.highlights;delete c.highlights;b.extend(c,this.options.annotationData);var d={json:b.toJSON(c)};c.highlights=e;return d}})})(jQuery);(function(a){Annotator.Plugins.User=DelegatorClass.extend({events:{annotationViewerShown:"updateViewerWithUsers"},options:{display:function(c,b){a(c).append('<span class="user">&ndash; '+b+"</span>")}},init:function(b,c){this.options=a.extend(this.options,b);this._super()},updateViewerWithUsers:function(d,f,c){var b=this;a(f).find("p").each(function(){var e=a(this).data("annotation").user;if(e){b.options.display(this,e)}})}})})(jQuery);